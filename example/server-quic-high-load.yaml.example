# paqet Server Configuration for High Connection Pressure with QUIC
#
# All buffer, window, and performance settings are now auto-tuned from CPU count
# and RAM at startup — this file is identical to server-quic.yaml.example.
# You no longer need a separate "high-load" config; the defaults are already
# optimized for high bandwidth.  Override individual fields only to fine-tune.
role: "server"

# Logging configuration
log:
  level: "info"  # Use "warn" or "error" at very high load to reduce overhead

# Server listen configuration
listen:
  addr: ":9999"   # CHANGE ME: Server listen port (must match network.ipv4.addr port)

# Network interface settings
network:
  interface: "eth0"                          # CHANGE ME: Network interface (eth0, ens3, en0, etc.)
  # guid: "\Device\NPF_{...}"                # Windows only (Npcap).

  # IPv4 configuration
  ipv4:
    addr: "10.0.0.100:9999"                  # CHANGE ME: Server IPv4 and port (port must match listen.addr)
    router_mac: "aa:bb:cc:dd:ee:ff"          # CHANGE ME: Gateway/router MAC address

  # TCP flags for packet crafting
  tcp:
    local_flag: ["PA"]                       # Local TCP flags (Push+Ack default)

# Transport protocol configuration — QUIC
transport:
  protocol: "quic"
  conn: 1           # Number of connections (1-256, default: 1)

  quic:
    # Server auto-generates a self-signed TLS certificate.
    # All QUIC settings are auto-tuned.  Override only if needed:
    # max_idle_timeout: 60               # seconds (auto: 60s server)
    # max_incoming_streams: 50000        # auto: cpus×12500, e.g. 50000 on 4 cores
    # keep_alive_period: 15

# Performance section is fully auto-tuned — only override if needed:
# performance:
#   max_concurrent_streams: 50000       # auto: cpus×12500, e.g. 50000 on 4 cores
#   packet_workers: 4                   # auto: GOMAXPROCS (capped at 64)
#   stream_worker_pool_size: 10000      # auto: cpus×2500
#   enable_connection_pooling: true     # defaults to false; enable for upstream TCP pooling
#   tcp_connection_pool_size: 500       # auto: cpus×125
#   tcp_connection_idle_timeout: 90
#   max_retry_attempts: 5
#   retry_initial_backoff_ms: 100
#   retry_max_backoff_ms: 10000

# Important: Server Firewall Configuration Required!
# 
# Since paqet uses pcap to bypass standard firewalls, you MUST configure
# iptables on the server to prevent kernel interference:
#
# sudo iptables -t raw -A PREROUTING -p tcp --dport 9999 -j NOTRACK
# sudo iptables -t raw -A OUTPUT -p tcp --sport 9999 -j NOTRACK  
# sudo iptables -t mangle -A OUTPUT -p tcp --sport 9999 --tcp-flags RST RST -j DROP
#
# Replace 9999 with your actual listen port.
#
# Additional OS-level tuning recommendations for high load:
#
# 1. Increase file descriptor limits:
#    sudo ulimit -n 1000000
#    Or add to /etc/security/limits.conf:
#    * soft nofile 1000000
#    * hard nofile 1000000
#
# 2. Increase system connection limits:
#    sudo sysctl -w net.core.somaxconn=65535
#    sudo sysctl -w net.ipv4.tcp_max_syn_backlog=65535
#    sudo sysctl -w net.core.netdev_max_backlog=65535
#
# 3. Optimize kernel socket buffers:
#    sudo sysctl -w net.core.rmem_max=134217728
#    sudo sysctl -w net.core.wmem_max=134217728
#    sudo sysctl -w net.ipv4.tcp_rmem='4096 87380 134217728'
#    sudo sysctl -w net.ipv4.tcp_wmem='4096 65536 134217728'
#
# 4. Enable TCP fast open:
#    sudo sysctl -w net.ipv4.tcp_fastopen=3
#
# 5. Reduce TIME_WAIT connections:
#    sudo sysctl -w net.ipv4.tcp_fin_timeout=15
#    sudo sysctl -w net.ipv4.tcp_tw_reuse=1
#
# To make these changes persistent, add them to /etc/sysctl.conf
